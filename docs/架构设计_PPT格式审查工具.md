## PPT格式审查工具 架构设计文档

### 1. 架构目标与约束
- 与《需求文档》一致：
  - 输出报告以 HTML/Markdown 为主；支持导出带标记PPT（注释版副本）；新增 WebUI（Streamlit）与桌面GUI（tk）并行，保留 CLI；
  - 性能目标：20页PPT在本地检查时间建议≤5分钟（普通办公本）；
  - 支持（可选）自动修复：字体/字号/颜色/术语统一；
  - 规则覆盖：字体/字号、英文缩略语解释、日文表述与行业用语、逻辑连贯、术语一致性、色调一致、颜色数量；
  - Windows优先，`.pptx` 文件，离线本地处理。

### 2. 总体架构
```
┌───────────────────────────────────────────────────────────┐
│                         CLI/API 层                        │
│  - 命令行入口（pptlint）  - WebUI（Streamlit） - 可选API包装 │
└───────────────┬──────────────────────────────────────────┘
                │
┌───────────────▼──────────────────────────────────────────┐
│                      应用协调器（App）                    │
│  - 加载配置  - 文件遍历  - 调度规则  - 聚合报告            │
└──────┬────────┬──────────────┬───────────┬───────────────┘
       │        │              │           │
┌──────▼───┐ ┌──▼──────────┐ ┌─▼────────┐ ┌▼─────────────┐ ┌▼─────────────┐
│ 解析层   │ │ 规则引擎    │ │ 自动修复 │ │ 报告生成器   │ │ 注释输出器   │
│ (PPTX)   │ │ (Rules)     │ │ (AutoFix)│ │ (Reporter)   │ │ (Annotator)  │
└──────┬───┘ └──┬─────┬─────┘ └──┬───┬───┘ └──┬───────────┘ └──┬───────────┘
       │        │     │          │   │        │               │
  ┌────▼───┐ ┌──▼───┐ ┌▼─────┐ ┌─▼─┐▼─┐   ┌──▼───────────┐   ┌▼───────────┐
  │文本提取│ │颜色提取│ │缩略语│ │术语一致│   │HTML/Markdown│   │标记PPT输出 │
  │Text    │ │Color  │ │Acronym│ │Terms  │   │报告/汇总    │   │(高亮/批注) │
  └────────┘ └───────┘ └──────┘ └──────┘   └──────────────┘   └────────────┘
```

### 3. 模块设计
1) CLI/入口模块
   - 职责：解析命令行参数、加载配置、调用应用协调器、退出码管理。
   - 关键参数：input、config、html/md 输出路径、autofix 白名单。

2) 应用协调器（App）
   - 职责：
     - 递归遍历文件/目录；
     - 调用解析层构建标准化文档模型（DocumentModel）；
     - 统一调度各规则；
     - 汇总问题项并调用自动修复/报告生成。
   - 错误处理：对单文件失败不影响整体；记录不可解析对象。

3) 解析层（PPTX Parser）
   - 依赖：Office Open XML 解析库（如 python-pptx 或等价实现）。
   - 输出：DocumentModel
     - Slides: [Slide]
     - Shapes: [TextShape, TableCell, GraphicText]
     - Style: 字体、字号、颜色（文本/填充/边框）、母版主题色
   - 颜色提取：归一化至统一颜色空间（sRGB），保留主题映射信息。

4) 规则引擎（Rules）
   - 统一接口：`Rule.check(DocumentModel) -> [Issue]`
   - 规则实现：
     - FontSizeRule（字体与字号≥12）
     - AcronymRule（英文缩略语需解释）
     - JapaneseFluencyRule（日文流畅性与汽车IT术语）
     - LogicCoherenceRule（标题层级与跨页连贯）
     - TerminologyConsistencyRule（术语一致性）
     - ThemeHarmonyRule（整体色调一致、与主题接近）
     - ColorCountRule（单页颜色数量阈值）
   - Issue结构：file、slideIndex、objectRef、ruleId、severity、message、suggestion、canAutoFix。

5) 自动修复（AutoFix）
   - 策略：仅对可安全确定的项执行（字体、字号、主题色映射、术语统一（需用户白名单））。
   - 接口：`AutoFix.apply(DocumentModel, issues, allowlist)`，返回修订版副本。

6) 报告生成（Reporter）
   - 输入：Issue 列表 + 汇总统计。
   - 输出：HTML 与/或 Markdown（与需求一致）。
   - 内容：规则分组、按页视图、可定位对象标识、修复建议与状态。

7) 配置与词库（Config/Dict）
   - 配置：字体名、最小字号、缩略语正则、颜色阈值、单页颜色阈值、自动修复白名单。
   - 词库：
     - 日文行业术语表（汽车IT）；
     - 禁用词/不推荐表达；
     - 术语一致性映射表（A->B）。

### 4. 数据模型（核心）
- DocumentModel
  - filePath: string
  - slides: Slide[]
- Slide
  - index: int
  - shapes: Shape[]
  - themeColors: Color[]
- Shape（抽象）
  - id: string
  - type: TextBox | TableCell | GraphicText
  - textRuns: TextRun[]
  - fillColor/borderColor/textColor: Color
- TextRun
  - text: string
  - fontName: string
  - fontSizePt: float
  - languageTag: string（用于日文检测）
- Issue
  - ruleId, severity, message, suggestion, canAutoFix, slideIndex, objectRef

### 5. 关键算法（简述）
- 字体/字号：逐 TextRun 校验；日文文本强制字体=Meiryo UI，字号>=12。
- 缩略语：正则匹配 ACRONYM（2-8大写），向前搜索同页/前文是否存在解释（全称或“简称：全称”模板）。
- 日文流畅性与术语：基于词库+规则提示（不自动改写）；提供候选替换。
- 逻辑连贯：检查标题层级（字体大小/粗细/占位版式特征）、跨页主题延续；标注断裂处。
- 术语一致性：基于映射表与相似度聚类，发现多写并推荐统一项。
- 色调一致：将对象颜色与主题色做近似匹配（阈值可配置），偏离则提示并可映射回主题色。
- 颜色数量：统计单页可区分颜色集合，超阈值则提示精简。

### 6. 性能与资源预算
- 目标：20页≤5分钟（普通办公本）。
- 策略：
  - 单文件顺序处理，规则共享同一解析结果；
  - 可选启用按页并行（线程池），默认关闭以降低资源占用；
  - 大对象懒加载文本与样式属性，避免重复解析；
  - 报告写入流式生成，减少内存峰值。

### 7. 质量与测试
- 单元测试：解析/规则/报告/修复的独立用例。
- 集成测试：含合规与不合规样例PPT。
- 回归测试：固定样例确保规则输出稳定。

### 8. 部署与运行
- 运行环境：Windows，Python 3.10+（或等价运行时）。
- 依赖建议：
  - pptx解析：python-pptx（或等价库）；
  - 文本语言/规则：regex 与轻量词库；
  - 大模型：OpenAI-compatible HTTP 接口（DeepSeek等），默认启用，失败自动降级；WebUI 提供 provider/model/api_key/endpoint 设置。
  - HTML/Markdown：Jinja2/Markdown 生成（或内置模板）。
- 分发方式：打包为可执行（pyinstaller）或以pip包形式提供。

### 9. 安全与隐私
- 本地处理，不上传文件；
- 若启用外部模型，需显式开关与脱敏策略，并在报告标注来源。

### 10. 演进路线
- v1：解析/规则/报告基础能力，支持字体/字号/颜色的安全修复。
- v1.1：术语一致性一键替换的交互式确认流。
- v1.2：逻辑连贯/日文表述的更强建议与可视化定位。


### 11. 用户审查需求解析器（User Requirements Parser）
- 输入：`docs/审查需求文档.md`（或等价输入渠道）。
- 输出：内存态的规则配置（合并到 `ToolConfig`），包括阈值/开关/术语表路径/模式选择（review|edit）。
- 规则：
  - 以用户填写为优先；未填写项使用默认配置（见 `configs/config.yaml`）。
  - 页范围过滤：仅对选定页执行规则与输出。
- 错误与容错：不合法项回退为默认并在报告“元信息”中记录。

### 12. 工作流编排器（Workflow Orchestrator）
- 目标：将解析→规则→（可选LLM）→注释/改写 串联为可复用流水线。
- 模式：
  - 审查模式（review）：仅输出“带标记PPT”；不改写用户内容。
  - 编辑模式（edit）：对安全项直接改写（字体/字号/颜色/术语统一）；语言/逻辑类遵循用户配置（仅建议或改写）。
- 机制：
  - 能力探测：仅调用已注册可用工具（解析器、规则、注释输出、改写器）。
  - 幂等输出：所有改写生成副本，不覆盖原文件；记录diff摘要。

### 13. LLM 建议器（LLM Advisor，可选）
- 用途：
  - 日文流畅性与汽车IT术语建议；
  - 上下文逻辑过渡与结构化标题建议；
  - 术语歧义判断与统一建议。
- 输入：从解析与规则阶段提取的文本块/标题结构/术语候选 + 用户需求约束。
- 输出：带置信度的建议项（替换候选、过渡语草稿、统一术语）。
- 安全：默认不上传；如启用，需终端点/脱敏策略/配额配置；失败自动降级为纯规则。

### 14. 工具注册表与能力清单（Tool Registry）
- 职责：统一登记所有可被编排器调用的本地工具与规则，包含：
  - 解析器：PPTX文本/颜色提取；
  - 规则：字体字号、缩略语、色调一致、颜色数量、（扩展）术语一致/逻辑/日文建议；
  - 输出器：注释输出（带标记PPT）；
  - 改写器：安全改写（字体/字号/颜色/术语统一）。
- 运行时：编排器仅根据能力清单调用“已实现且启用”的组件，避免空调用与异常。

### 11. 注释输出（Annotator）
- 输入：Issue 列表 + 原始PPTX路径；
- 输出：带标记PPT副本（不覆盖原文件）；
- 标记策略：
  - 首页全局“问题汇总”（中文类别聚合、过滤info）；
  - 对命中对象（shape_id匹配）在文本末尾追加“【标记: 中文类别...】”；
  - 不改变原有版式与主题，仅追加文本元素；
  - 若对象为页级（object_ref=page），仅在“问题汇总”中体现。


